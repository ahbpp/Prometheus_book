![#Prometheus DB](images/title.png)

<!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->

- [Введение](#%D0%B2%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5)
- [История](#%D0%B8%D1%81%D1%82%D0%BE%D1%80%D0%B8%D1%8F)
- [Установка](#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0)
- [Архитектура](#%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0)
- [Начало работы](#%D0%BD%D0%B0%D1%87%D0%B0%D0%BB%D0%BE-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B)
- [Язык запросов](#%D1%8F%D0%B7%D1%8B%D0%BA-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%BE%D0%B2)
	- [Типы данных языка выражений](#%D1%82%D0%B8%D0%BF%D1%8B-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-%D1%8F%D0%B7%D1%8B%D0%BA%D0%B0-%D0%B2%D1%8B%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9)
	- [Селекторы временных рядов](#%D1%81%D0%B5%D0%BB%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D1%8B-%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D1%8B%D1%85-%D1%80%D1%8F%D0%B4%D0%BE%D0%B2)
		- [Селекторы мгновенные векторов](#%D1%81%D0%B5%D0%BB%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D1%8B-%D0%BC%D0%B3%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5-%D0%B2%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D0%BE%D0%B2)
		- [Селекторы векторов диапазона](#%D1%81%D0%B5%D0%BB%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D1%8B-%D0%B2%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D0%BE%D0%B2-%D0%B4%D0%B8%D0%B0%D0%BF%D0%B0%D0%B7%D0%BE%D0%BD%D0%B0)
		- [Модификатор сдвига](#%D0%BC%D0%BE%D0%B4%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80-%D1%81%D0%B4%D0%B2%D0%B8%D0%B3%D0%B0)
	- [Операторы](#%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%82%D0%BE%D1%80%D1%8B)
- [Использование](#%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
	- [Prometheus Python Client](#prometheus-python-client)
		- [Установка](#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-1)
		- [Примеры](#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D1%8B)
- [Полезные программы и утилиты](#%D0%BF%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D1%8B%D0%B5-%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D1%8B-%D0%B8-%D1%83%D1%82%D0%B8%D0%BB%D0%B8%D1%82%D1%8B)
- [Grafana](#grafana)
- [Больше о Prometheus DB](#%D0%B1%D0%BE%D0%BB%D1%8C%D1%88%D0%B5-%D0%BE-prometheus-db)

<!-- /TOC -->

## Введение

Prometheus это `time-series` база данных, использующияся
для мониторинга событий и сигнализации в реальном времени. Проект был
 изначально создан для мониторинга микросервисов.  

 Мониторинг микросервисов является достаточно сложной задачей,
 потому что нужно отслеживать как состояние системы в целом так в
 отдельности каждого микросервиса. Задача усложняется, если
 помимо технических нужно проверять ещё и бизнес-значимые показатели.
 Разработчики Prometheus утверждают, что на рынке не существовало инструментов
 на рынке, позволяющих решать ее без проблем.  

Prometheus представляет собой комплексное решение, в состав которого
входят и фреймворк для мониторинга, и собственная `time-series` база данных.

В этом пособии будут рассказаны такие базовые вещи как, установка базы данных,
ее запуск, рассмотрены базовые возможности, а также приведены несколько примеров
ее использования. Стоит отметить, что автор является хейтером windows os,
а также любителем языка `Python`. Всвязи с этим про работу базы на windows
ничего рассказано не будет, а большенство приведенных примеров будет на языке
`Python`.
Также на официальном [сайте базы данных](https://prometheus.io) можно найти больше
информации о ней, а также докуметацию и туториалы от авторов проекта.

## История
Идея создания и разработка Prometheus DB принадлежит
[Matt T. Proud ](https://www.matttproud.com/index.html) и
[Julius Volz](http://juliusv.com/), но большая часть первоначальной разработки
была спонсирована сервисом [SoundCloud](https://soundcloud.com/).
База данных была представлена в 2012 году в качестве внутренней системы
мониторинга SoundCloud, но впоследствии получила широкое распространение.
Первый публичный релиз состоялся в 2015 году, а в качестве подтверждения намерений
стать open-source проектом присоеднился к
[Cloud Native Computing Foundation](https://www.cncf.io) в 2016 году.  

В ноябре 2017 был представлен Prometheus v.2.0, база данных стала быстрее в
накоплении данных и скорости работы, а также повысилась эффективность использования ресурсов.  

Сейчас Prometheus является полностью независимым проектом, поддерживаемый
несколькими крупными компаниями. Каждый может внести свой вклад в разработку,
подрабная инструкция представлена на github
[prometheus](https://github.com/prometheus/prometheus/blob/master/CONTRIBUTING.md).  


## Установка

Для опреационных систем `mac os` и `Linux` установка очень проста. Для начала
переходим на [страницу установки](https://prometheus.io/download/) и скачиваем
 нужный `tar.gz` архив. Затем открываем терминал, преходим в папку с архивом и
 вводим команды:

```{r, engine='bash', count_lines}
  user$ tar xvfz prometheus-*.tar.gz
  cd prometheus-*
```

Мы оказались в корневой папке базы данных и все готово к запуску нашей первой программы.  

Также для дальнейшего прочтения попосбия стоит установить компиляторы для языка
`Go` и  `Python` (на macOS это можно сделать командой `brew install go/python`).

<!-- Для запуска стандартной программы вводим строчку
`./prometheus --config.file=prometheus.yml`, а затем переходим на
[localhost:9090](localhost:9090), также можно посмотреть на метрики и графики
стандртных метрик по ссылкам [localhost:9090/metrics](localhost:9090/metrics) и
[http://localhost:9090/graph](http://localhost:9090/graph). -->



База данных написна на языке `Go`, но также имеет официальные клиентские
библиотеки на языках `Python`, `Java`, `Ruby` и собственно `Go`.

## Архитектура

В состав Prometheus входят следующие компоненты:

* сервер, который считывает метрики и сохраняет их в time series базе данных;
* клиентские библиотеки для различных языков программирования (Go, Java, Python, Ruby; сообществом также созданы библиотеки для Bash, Node.js, Haskell, .NET/C#);
* PROMDASH — дашборд для метрик;
* инструменты для экспорта данных из сторонних приложений (Statsd, Ganglia, HAProxy и других);
* менеджер уведомлений AlertManager (на текущий момент находится на стадии бета-тестирования);
* клиент командной строки для выполнения запросов к данным.  

![Архитектура](images/arch_1.png)

Главный компонент всей системы — сервер Prometheus. Он работает автономно и сохраняет все данные в локальной базе данных. Обнаружение сервисов происходит автоматически. Это упрощает процедуру развёртывания: для наблюдения за одним сервисом не нужно разворачивать распределённую систему мониторинга; достаточно установить только сервер и необходимые компоненты для сбора и экспорта метрик.
Таких компанентов уже написано много под различные сервисы и ПО, весь список
доступен на [github](https://github.com/prometheus).  

Prometheus хранит данные в виде временных рядов — наборов значений, соотнесённых с временной меткой (timestamp). Элемент временного ряда (измерение) состоит из имени метрики, временной метки и пары «ключ — значение». Временные метки имеют точность до миллисекунд, значения представлены во float64.  

 В Prometheus используются следующие типы метрик:
 * счётчик (counter) — хранит значения, которые увеличиваются с течением времени (например, количество запросов к серверу);
* шкала (gauge) — хранит значения, которые с течением времени могут как увеличиваться, так и уменьшаться (например, объём используемой оперативной памяти или количество операций ввода-вывода);
* гистограмма (histogram) — хранит информацию об изменении некоторого параметра в течение определённого промежутка (например, общее количество запросов к серверу в период с 11 до 12 часов и количество запросов к этому же серверов в период с 11.30 до 11.40);
* сводка результатов (summary) — как и гистограмма, хранит информацию об изменении значения некоторого параметра за временной интервал, но также позволяет рассчитывать квантили для скользящих временных интервалов.


## Начало работы

Начинать работу стоит с прохождения раздела [getting_started started ](https://prometheus.io/docs/prometheus/latest/getting_started/). В нем рассказывается
как установить, задать конфигурацию и использовать Prometheus на простейших
примерах. Установка базы данных была рассмотрена [выше](#Установка), поэтому
в этом разделе будут рассмотрены только простйешие примеры.  

Для начала в файле `prometheus.yml` задааются параметры с которыми запуститься
база данных. Рассмотрим его подробнее:  
```
global:
 scrape_interval:     15s #интервал сбора метрик (по умолчанию — 15 секунд);
 evaluation_interval: 15s #интервал сверки с правилами (по умолчанию — 15 секунд);

 external_labels:
   monitor: 'codelab-monitor'

rule_files:
 - 'prometheus.rules.yml' # файл правил

scrape_configs:
 - job_name: 'prometheus'

   scrape_interval: 5s #переопределение интервал сбора метрик для конкретной джобы

   static_configs: # сервисы и группы сервисов, для которых нужно собирать метрики.
     - targets: ['localhost:9090']
```

Также стоит отметить, что в секции `static_configs` могут быть параметры:  
* scrape_timeout — время ожидания данных;
* metrics_path — HTTP-ресурс, на который будут передаваться метрики;
* scheme — протокол, который будет использоваться для передачи метрик;
* basic_auth — реквизиты для авторизации на сервере, с которого будут собираться метрики (username:, password:).

Подробнее стоит рассказать о фалах-правил. Они выполняются во время сбора данных и позволяют сразу проводить сложные вычисления и сохранить новый временной ряд. Таким образом при каждом обращении, база данных обращается к уже посчитанным данным, что делаеи ее быстрее и эффективнее.  

Вернемся к запуску prometheus. Для запуска необходимо выполнить следующую
команду:
```
./prometheus --config.file=prometheus.yml
```

После запуска переходим на [localhost:9090](localhost:9090) и видим приятный стандартный веб-интерефейс prometheus. Можем выбрать одну из предложенных стандатрных программ prometheus и выполнить ее. Например, `go_memstats_heap_alloc_bytes` и посмотреть сколько выделелось байт на куче.  

![](images/start_1.png)

Также можно посмотреть на метрики и графики стандртных метрик по ссылкам [localhost:9090/metrics](localhost:9090/metrics) и
[http://localhost:9090/graph](http://localhost:9090/graph).

Для следующих примеров нам понадобиться установленный компилятор языка Go, а также установленный   git в терминале.  

Для начала клонируем исходники с git и собираем их go компилятором следующими командами:  
```
git clone https://github.com/prometheus/client_golang.git
cd client_golang/examples/random
go get -d
go build
```

Далее запускаем в трех различных терминалах 3 следующие примеры (каждый в своем):
```
./random -listen-address=:8080
./random -listen-address=:8081
./random -listen-address=:8082
```

Соотвественно на каждом из трех портов мы можем посмотреть метрики: [http://localhost:8080/metrics](http://localhost:8080/metrics), [http://localhost:8081/metrics](http://localhost:8081/metrics), [http://localhost:8082/metrics](http://localhost:8082/metrics).

Выяглядит все это не очень понятно и интресно и понятно, поэтому давайте настроим конфигурацию prometheus для мониторинга этих метрик. Для этого добавим в наш `prometheus.yml`  файл следующий scrape_configs:

```
scrape_configs:
 - job_name:       'example-random'

	scrape_interval: 5s

	static_configs:
		- targets: ['localhost:8080', 'localhost:8081']
			labels:
				group: 'production'

		- targets: ['localhost:8082']
			labels:
				group: 'canary'
```

После этого снова запускаем команду:
```
./prometheus --config.file=prometheus.yml
```

Также в этом примере показано,  что мы можем добавить группы для нескольких джоб, и затем добавлять лейблы для каждой группы.  

Можем убедиться, что у нас появилась в дашборд prometheus новая метрика `rpc_durations_seconds`.  
![](images/start_2.png)



## Язык запросов

В Prometheus DB, удивительно, но язык запросов называется PromQL)  

А если серьезно, то Prometheus предоставляет функциональный язык запросов PromQL (Prometheus Query Language), который позволяет пользователю выбирать и агрегировать данные временных рядов в режиме реального времени. Результат выражения может быть отображен в виде графика, отображен в виде табличных данных в браузере выражений Prometheus или использован внешними системами через HTTP API.  

### Типы данных языка выражений
В языке Прометея выражение или подвыражение может являться в одним из четырех типов:

* Мгновенный вектор - набор временных рядов, содержащий одну выборку для каждого временного ряда, все с одной и той же временной меткой
 * Диапазон вектора - набор временных рядов, содержащий диапазон точек данных во времени для каждого временного ряда
* Скаляр - простое числовое значение с плавающей точкой
* String - простое строковое значение(deprecated);  


В зависимости от варианта использования (например, при построении графиков и отображении выходных данных выражения) только некоторые из этих типов можно использовать. Например, выражение, которое возвращает мгновенный вектор, является единственным типом, который может быть непосредственно отображен.  

### Селекторы временных рядов

#### Селекторы мгновенные векторов

Мгновенные селекторы векторов позволяют выбирать набор временных рядов и одно значение выборки для каждого в определенный момент времени: в простейшей форме указывается только имя метрики. Тогда на выходе получается мгновенный вектор, содержащий элементы для всех временных рядов, которые имеют это имя метрики.  

В следующем примере выбираются все временный ряды содеражщие метрик с именем `rpc_durations_seconds` (из раздела #Начало работы) c определенной джобой и состоящей в определенной группе:
```
rpc_durations_seconds{group="production", job="example-random"}
```

![](images/promql_1.png)

Также можно перейти во вкладку `Console` и например посмотреть значения метрик за последнюю минуту с помощью следующей команды:
```
rpc_durations_seconds{group="production", job="example-random"}[1m]
```

![](images/promql_2.png)

Также поддерживается язык регулярных выражений [RE2 syntax](https://github.com/google/re2/wiki/Syntax). Специально для них поддерживаются следующие операторы:
* `=`: Выбирает метки, которые в точности равны указанной строке.
* `!=`: Выбирает метки, которые не равны предоставленной строке.
* `=~`: Выбирает метки, которые соответствуют регулярному выражению предоставленной строки.
* `!~`: Выбирает метки, которые не соответствуют регулярному выражению указанной строки.  

Например можно выполнить следующий запрос, выдающий метрики только с двух хостов:
```
rpc_durations_seconds{instance=~"localhost:8080|localhost:8081"}
```

![](images/promql_3.png)

#### Селекторы векторов диапазона

Работать с векторами диапазона аналогично мгновенным векторов, за исключением того, что они выбирают диапазон выборок в прошлое начиная с текущего момента. Синтаксически, длительность диапазона добавляется в квадратных скобках (`[]`) в конце запроса, чтобы указать, как далеко назад во времени должны выбираться значения для каждого элемента вектора диапазона.  

Продолжительность времени указывается в виде числа, за которым сразу следует одна из следующих единиц измерения:
* s - секунды
* h - часы
* d - дни
* w - недели
* y - года

Можно выполнить следуюзий пример запроса  и посмотреть в консоле значение метрик за порследнюю минуту:  
```
rpc_durations_seconds{instance=~"localhost:8080|localhost:8081"}[1m]
```
![](images/promql_4.png)

#### Модификатор сдвига

Модификатор сдвига(`offset`) позволяет изменять временной сдвиг для отдельных векторов мгновенных значений и диапазонов в запросе.
Например, следующее выражение возвращает значение `rpc_durations_seconds{instance=~"localhost:8080|localhost:8081"}`, которое было 5 минут назад относительно текущего момента времнни:

```
rpc_durations_seconds{group="production", job="example-random"} offset 5m
```
![](images/promql_5.png)

Нужно иметь ввиду, что `offset` нужно указывать сразу после слектора, как например в таком запросе, возращающий сумму мтерик 5 минут назад:
```
sum(rpc_durations_seconds{group="production", job="example-random"} offset 5m)
```
Результаты предыдущего запроса посмотрите самостоятельно.

### Операторы

Подробно про операторы можно почитать [документации](https://prometheus.io/docs/prometheus/latest/querying/operators/)

Кратко: поддерживаются бинарные и арифметически между:
* двумя числами
* мгновенным вектором и числом
* между двумя мгновенными векторами

Первые два очевидно как работают, приведем пример для третьего пункта. Важно, что возможны операции только между векторами с одинаковыми метками. Если необходимо оперировать векторами с различными метками, то используется ключевое слово `ignore`, чтобы не учитывать конкретную метку. Собственно запрос и результат его выполнения:
```
rpc_durations_seconds{instance="localhost:8081"}  / ignoring(instance) rpc_durations_seconds{instance="localhost:8080"}
```
![](images/promql_6.png)


## Использование

Prometheus предоставляет официальные клиентские библитеки на четырех языках:

* Go
* Java or Scala
* Python
* Ruby

А также существуют нефоциальные клиентские библиотеки практически на всех языкахпрограммирования. Подробнее о них можно узнать по на ![официальной странице](https://prometheus.io/docs/instrumenting/clientlibs/). Более того если ни одна из предложенных библитек не устравет или не существует под необходимый язык, то можно написать свою.  

В этом разделе будет рассмотрена библиотека на языке Python.

### Prometheus Python Client

#### Установка
Все очень просто)))  

```
pip install prometheus_client
```

#### Примеры

Копируем этот шикарный питновский код и запускаем.

```python
from prometheus_client import start_http_server, Summary
import random
import time

# Создаем метрику
REQUEST_TIME = Summary('request_processing_seconds', 'Time spent processing request')

# Магический декоратор над функцией
@REQUEST_TIME.time()
def process_request(t):
    """A dummy function that takes some time."""
    time.sleep(t)

if __name__ == '__main__':
    # Выбираем где запускаем
    start_http_server(8000)
    # Генерируем данные
    while True:
        process_request(random.random())
```

Посещаем шикарный [http://localhost:8000/](http://localhost:8000/).  
Видим, что появились новые метрики:
* `request_processing_seconds_count`: количество вызовов функции.
* `request_processing_seconds_sum`: общее количество времени, которое выполнялась функция.



## Полезные программы и утилиты

### Grafana

В первую очередь стоит упоменуть о совместимости Prometheus и отличного грфического визуолизатора ![Gafana](https://grafana.com/). Установить ее можно по ![инструкции](https://grafana.com/grafana/download/)

#### Использование

По умолчанию Grafana запускается на http://localhost:3000.

**Создание источника данных для Prometheus:**

355/5000
Нажмите на логотип Grafana, чтобы открыть меню боковой панели.
Нажмите «Источники данных» на боковой панели.
Нажмите «Добавить новый».
Выберите «Прометей» в качестве типа.
Установите соответствующий URL-адрес сервера Prometheus (например, http: // localhost: 9090 /)
При необходимости настройте другие параметры источника данных (например, отключите доступ к прокси-серверу).
Нажмите «Добавить», чтобы сохранить новый источник данных.
Nazhmite na logotip

## Больше о Prometheus DB

##
